---
title: "Baseline model with Tidymodels"
author: "ìŠ¬ê¸°ë¡œìš´í†µê³„ìƒí™œ"
date: "4/6/2021"
output: html_document
---

# ìŠ¬ê¸°ë¡œìš´ í†µê³„ìƒí™œ at DACON!

ì•ˆë…•í•˜ì„¸ìš”~! ìš”ì¦˜ í•«í•œ Tidymodelsë¥¼ ì‚¬ìš©í•´ì„œ ì›”ê°„ ë°ì´ì½˜ 14 - ì‹ ìš©ì¹´ë“œ ì‚¬ìš©ì ì—°ì²´ ì˜ˆì¸¡ AI ê²½ì§„ëŒ€íšŒ ë² ì´ìŠ¤ë¼ì¸ì„ ì¡ì•„ë³´ì. ğŸ˜

# ì¤€ë¹„ì‘ì—…

## íŒ¨í‚¤ì§€ ë¶ˆëŸ¬ì˜¤ê¸°

ì´ë²ˆ í¬ìŠ¤íŒ…ì—ì„œ ì‚¬ìš©í•  RíŒ¨í‚¤ì§€ë“¤ì„ ë¶ˆëŸ¬ì˜¤ì. íŠ¹íˆ ìš”ì¦˜ í•«í•˜ë”” í•«í•œ `tidymodels` ì‚¬ìš©í•˜ì—¬ ì›”ë§ˆíŠ¸ ëŒ€íšŒë¥¼ ê°€ì§€ê³  ë†€ì•„ë³¸ë‹¤. ë˜í•œ ë§ˆì´ ë¹¼ì´ë³´ë¦¿ ì—°ì‚°ìë“¤ì„ ì‚¬ìš©í•˜ê¸° ìœ„í•˜ì—¬ `magrittr`ë¥¼ ë¶ˆëŸ¬ì™”ë‹¤.ğŸ¤£

```{r}
suppressMessages(library(tidymodels))
suppressMessages(library(tidyverse))
suppressMessages(library(data.table))
suppressMessages(library(treesnip))
suppressMessages(library(magrittr))
suppressMessages(library(skimr))
suppressMessages(library(knitr))
theme_set(theme_bw())
```

## ë°ì´í„°ì…‹ ë¶ˆëŸ¬ì˜¤ê¸°

ì´ ëŒ€íšŒì—ì„œ ì£¼ì–´ì§„ ë°ì´í„°ì…‹ì„ ë¶ˆëŸ¬ë³´ì. ì£¼ì–´ì§„ íŒŒì¼ ë¦¬ìŠ¤íŠ¸ëŠ” ë‹¤ìŒê³¼ ê°™ë‹¤.

```{r}
file_path <- "../input/daconcredit14/"
files <- list.files(file_path)
files
```
ê° ë³€ìˆ˜ì˜ ì´ë¦„ì„ `janitor` íŒ¨í‚¤ì§€ë¡œ ë§ë”í•˜ê²Œ ë°”ê¿”ì¤€ë‹¤.

```{r}
train <- read_csv(file.path(file_path, "train.csv")) %T>% 
  suppressMessages() %>% 
  janitor::clean_names()
test <- read_csv(file.path(file_path, "test.csv")) %T>%
  suppressMessages() %>% 
  janitor::clean_names()
```


# ë°ì´í„° ê¸°ë³¸ì •ë³´ í™•ì¸

```{r}
train %>% 
  head() %>% 
  kable() %>% 
  kableExtra::kable_styling("striped") %>% 
  kableExtra::scroll_box(width = "100%")
```

## ê¸°ë³¸ ì •ë³´

ì´ ëŒ€íšŒëŠ” ê¸°ë³¸ì ìœ¼ë¡œ ê°„ë‹¨í•œ ëŒ€íšŒì´ë‹¤. ì²«ë²ˆì§¸ ìŠ¤í„°ë””ìš© ëŒ€íšŒë¡œ ì„ íƒì„ í•œ ì´ìœ ì´ê¸°ë„ í•˜ë‹¤. ì£¼ ë°ì´í„°ëŠ” 2ë§Œ 6ì²œê°œì˜ train í‘œë³¸ê³¼ 1ë§Œê°œì˜ test í‘œë³¸ë“¤ë¡œ êµ¬ì„±ì´ ë˜ì–´ìˆë‹¤.

```{r}
dim(train)
```

```{r}
dim(test)
```

ê° ë°ì´í„° ì…‹ì˜ ë³€ìˆ˜ëª…ì„ ì‚´í´ë³´ì. 

```{r}
names(train)
```

```{r}
names(test)
```

ë¨¼ì € `test` ë°ì´í„°ì—ëŠ” ìš°ë¦¬ê°€ ì˜ˆì¸¡í•˜ê³  ì‹¶ì€ ë³€ìˆ˜ì¸ `credit` ë³€ìˆ˜ê°€ ë“¤ì–´ìˆì§€ ì•Šì€ ê²ƒì„ ì•Œ ìˆ˜ ìˆë‹¤. 

ë°ì´í„°ë¥¼ í›‘ì–´ë³´ê¸° ìœ„í•´ì„œ `skim()` í•¨ìˆ˜ë¥¼ ì´ìš©í•˜ì. ì´ í•¨ìˆ˜ëŠ” ë°ì´í„°ì— ë“¤ì–´ìˆëŠ” ë³€ìˆ˜ë“¤ì„ íƒ€ì… ë³„ë¡œ ë¶„ì„í•´ì„œ ë¦¬í¬íŠ¸ë¥¼ ì‘ì„±í•´ì¤€ë‹¤.

```{r}
skim(train)
```

ê²°ê³¼ë¥¼ ì‚´í´ë³´ì. ë¨¼ì € ê²°ì¸¡ì¹˜ê°€ ìƒëŒ€ì ìœ¼ë¡œ ë§ì´ ì—†ëŠ” ì°©í•œ? ë°ì´í„°ì´ë‹¤. character ë³€ìˆ˜ì˜ complete rateë¥¼ ì‚´í´ë³´ë©´ ëª¨ë“  ë³€ìˆ˜ê°€ 1ì´ê³ , `occyp_type` ë³€ìˆ˜ë§Œì´ ê²°ì¸¡ì¹˜ê°€ 8171ê°œê°€ ì¡´ì¬í•˜ëŠ” ê²ƒì„ ì•Œ ìˆ˜ ìˆë‹¤. ë˜í•œ ê³ ë§™ê²Œë„ numeric ë³€ìˆ˜ì˜ ê²°ì¸¡ì¹˜ëŠ” í•˜ë‚˜ë„ ì—†ë‹¤!ğŸ˜†

ê°™ì€ í•¨ìˆ˜ë¥¼ ì‚¬ìš©í•´ì„œ `test` ì…‹ì„ ë³´ë©´ ë˜‘ê°™ì€ íŒ¨í„´ì„ ê°€ì§€ê³  ìˆëŠ” ê²ƒì„ ì•Œ ìˆ˜ ìˆë‹¤.

```{r}
skim(test)
```

# ì‹œê°í™”

ë² ì´ìŠ¤ ë¼ì¸ì„ ì¡ì€ ë¬¸ì„œì´ë‹ˆ ê°„ë‹¨í•˜ê²Œ ì‹œê°í™” í•˜ë‚˜ë§Œ í•˜ê³  ë„˜ì–´ê°€ì. (ì½”ë“œë¥¼ ì‘ìš©í•´ì„œ ë‹¤ë¥¸ ë³€ìˆ˜ì— ëŒ€í•œ ìƒê´€ ê´€ê³„ë¥¼ ë³¼ ìˆ˜ ìˆì„ ê²ƒì´ë‹¤.)

```{r}
train %>%
  ggplot(aes(x = factor(credit), y = income_total)) +
  geom_boxplot() +
  facet_grid(. ~ income_type)
```

ëª©í‘œ ë³€ìˆ˜ì¸ creditì´ Commercial associate ì¸ ê²½ìš° ìˆ˜ì…ì´ ì¦ê°€í•  ìˆ˜ë¡ 2ë²ˆì§¸ í´ë˜ìŠ¤ì— ì†í•˜ëŠ” ê²ƒì„ ë³¼ ë•Œ, 0ì—ì„œ 2ë¡œ ì˜®ê²¨ê°ˆ ìˆ˜ ë¡ ì‹ ìš©ë„ê°€ ë†’ì€ í´ë˜ìŠ¤ë¼ëŠ” ê²ƒì„ ì˜ˆì¸¡í•´ ë³¼ ìˆ˜ ìˆë‹¤.

í•™ìƒ í´ë˜ìŠ¤ì˜ ê²½ìš° train ë°ì´í„°ì— ì…‹ì´ ë§ì´ ì—†ë‹¤ëŠ” ê²ƒì„ ì•Œ ìˆ˜ ìˆë‹¤. ì¶”í›„ì— ë‹¤ë¥¸ í´ë˜ìŠ¤ë¡œ í†µí•©ì„ ì‹œí‚¤ëŠ” ê²ƒì´ ì¢‹ì„ ê²ƒì´ë‹¤.

## ìƒê´€ê´€ê³„

ì‹ ìš© ë“±ê¸‰ ìˆ«ìê°€ ë†’ì„ ê²½ìš° ì‹ ìš©ì´ ë” ì¢‹ì•„ì§„ë‹¤ëŠ” ì•ì—ì„œì˜ ê°€ì •í•˜ì— ìƒê´€ê³„ìˆ˜ë¥¼ êµ¬í•´ë³´ë©´ ë‹¤ìŒê³¼ ê°™ë‹¤. 

```{r}
options(max.print = 50)
train %>% 
  select_if(is.numeric) %>% 
  drop_na() %>% 
  cor() %>% as.data.frame() %>% 
  rownames_to_column(var = "variables") %>% 
  select(variables, credit) %>% 
  arrange(desc(abs(credit))) %>% kable()
```

ìƒê°ë³´ë‹¤ í¬ê²Œ ë‚˜ì˜¤ì§€ëŠ” ì•Šì§€ë§Œ, ê·¸ë˜ë„ ê°€ì…ê¸°ê°„ê³¼ ë‚˜ì´ê°€ ì‹ ìš©ë„ì— ì˜í–¥ì„ ë¯¸ì¹˜ëŠ” ê²ƒ ê°™ë‹¤ê³  ìƒê°ëœë‹¤. ë‹¤ë§Œ, ë‘ ë³€ìˆ˜ì™€ ì‹ ìš©ë„ì˜ ê´€ê³„ë¥¼ ì–‘ì˜ ìƒê´€ê´€ê³„ë¡œ ë°”ê¾¸ê¸° ìœ„í•´ì„œ ì „ì²˜ë¦¬ ê³¼ì •ì—ì„œ ë¶€í˜¸ë¥¼ ì—†ì• ì£¼ì—ˆë‹¤.

```{r}
train %>% ggplot(aes(x = -(days_birth/356))) +
  geom_histogram() +
  labs(x = "yrs")
```

# ì „ì²˜ë¦¬ í•˜ê¸°

`tidymodels`ì—ì„œëŠ” ì „ì²˜ë¦¬ë¥¼ í•  ë•Œ `recipe` ë¼ëŠ” íŒ¨í‚¤ì§€ë¥¼ ì‚¬ìš©í•œë‹¤. ì´ íŒ¨í‚¤ì§€ì—ëŠ” ì „ì²˜ë¦¬ë¥¼ í•˜ëŠ” ë°©ë²•ì„ ìŒì‹ ë ˆí”¼ì‹œ ì²˜ëŸ¼ ì ì–´ë†“ëŠ”ë‹¤ê³  ìƒê°í•˜ë©´ ì‰½ë‹¤.

## all_data ë¬¶ê¸°

ì•ìœ¼ë¡œ ì „ì²˜ë¦¬ë¥¼ í•  ë•Œ ì¢€ ë” í¸ë¦¬í•˜ê²Œ í•˜ê¸° ìœ„í•´ì„œ `all_data`ë¡œ ë¬¶ì–´ë‚´ë„ë¡ í•˜ì.

```{r}
all_data <- bind_rows(train, test)
all_data %>% dim()
```

## factor ë³€ìˆ˜ë¡œ ë°”ê¿”ì£¼ê¸°

ê²°ê³¼ê°’ì¸ credit ë³€ìˆ˜ì™€ character íƒ€ì…ì˜ ë³€ìˆ˜ë“¤ì„ factor ë³€ìˆ˜ë¡œ ë°”ê¿”ì£¼ì.

```{r}
all_data %<>%
  mutate_if(is.character, as.factor) %>% 
  mutate(credit = factor(credit))

all_data
```

## `recipe`ë¥¼ í†µí•œ ì „ì²˜ë¦¬ ì…ë ¥

```{r}
credit_recipe <- all_data %>% 
  recipe(credit ~ .) %>% 
  step_mutate(yrs_birth = -ceiling(days_birth/365),
              yrs_employed = -ceiling(days_employed/356)) %>% 
  step_rm(index, days_birth, days_employed) %>%
  step_unknown(occyp_type) %>% 
  step_integer(all_nominal(), -all_outcomes()) %>% 
  step_center(all_predictors(), -all_outcomes()) %>% 
  prep(training = all_data)

print(credit_recipe)
```

## `juice`ë¥¼ í†µí•œ ì „ì²˜ë¦¬ ì¦™ì§œê¸°

`juice()` í•¨ìˆ˜ë¥¼ í†µí•´ì„œ recipeì— ì…ë ¥ëœ ì „ì²˜ë¦¬ë¥¼ ì§œë‚¸ ë°ì´í„°ë¥¼ ì–»ì–´ì˜¨ë‹¤.

```{r}
all_data2 <- juice(credit_recipe)
head(all_data2)
```

ë‹¤ìŒê³¼ ê°™ì´ ê²°ì¸¡ì¹˜ ì—†ì´ ì˜ ì½”ë”©ëœ ë°ì´í„°ë¥¼ ì–»ì—ˆë‹¤ëŠ” ê²ƒì„ í™•ì¸ í•  ìˆ˜ ìˆë‹¤.

```{r}
all_data2 %>%
map_df(~sum(is.na(.))) %>%
  pivot_longer(cols = everything(),
       names_to = "variable",
       values_to = "na_count") %>% 
  filter(na_count > 0)
```

ì „ì²˜ë¦¬ê°€ ëë‚¬ìœ¼ë¯€ë¡œ, trainê³¼ testì…‹ì„ ë‚˜ëˆˆë‹¤.

```{r}
train_index <- seq_len(nrow(train))
train2 <- all_data2[train_index,]
test2 <- all_data2[-train_index,]
```

# íŠœë‹ ì¤€ë¹„í•˜ê¸°

`validation_split()` í•¨ìˆ˜ë¥¼ ì‚¬ìš©í•˜ì—¬ í‰ê°€ì…‹ì„ ë¶„ë¦¬í•œë‹¤. í•œ ë‹¨ê³„ ë” ë‚˜ì•„ê°„ cross validationì€ `vfold_cv()`í•¨ìˆ˜ì—ì„œ ì œê³µí•˜ë‹ˆ ì°¾ì•„ë³´ë„ë¡ í•˜ì.

```{r}
set.seed(2021)

validation_split <- validation_split(train2, prop = 0.7,
                                     strata = credit)
```

## íŠœë‹ ìŠ¤í™ ì„¤ì •

```{r}
tune_spec <- boost_tree(
    trees = 1000, 
    tree_depth = 12, 
    min_n = 3, 
    loss_reduction = tune(),  
    sample_size = 0.3779710, 
    mtry = tune(),
    learn_rate = 0.012945107
) %>% 
    set_engine('xgboost', objective = "multi:softprob") %>% 
    set_mode('classification')

param_grid <- grid_latin_hypercube(
    # min_n(), 
    loss_reduction(),
    finalize(mtry(), train2[-1]),
    size = 50
)
```

## ì›Œí¬ í”Œë¡œìš°

```{r}
workflow <- workflow() %>%
  add_model(tune_spec) %>% 
  add_formula(credit ~ .)
```

## íŠœë‹

```{r}
library(doParallel)
Cluster <- makeCluster(detectCores() - 1)
registerDoParallel(Cluster)

library(tictoc)
tic()
tune_result <- workflow %>% 
  tune_grid(validation_split,
            grid = param_grid,
            metrics = metric_set(mn_log_loss))
toc()
```

```{r}
tune_result %>% 
  collect_metrics()
```

# íŠœë‹ê²°ê³¼ ì‹œê°í™”

```{r message=FALSE}
tune_result %>%
  collect_metrics() %>%
  filter(.metric == "mn_log_loss") %>% 
  ggplot(aes(mtry, mean, color = .metric)) +
  geom_line(size = 1.5) +
  scale_x_log10() +
  theme(legend.position = "none") +
  labs(title = "Mean Log loss")
```

```{r}
tune_result %>% show_best()
```

# ëª¨ë¸ í™•ì •

```{r}
tune_best <- tune_result %>% select_best(metric = "mn_log_loss")
final_spec <- finalize_model(tune_spec, tune_best)
final_spec
# Boosted Tree Model Specification (classification)
# 
# Main Arguments:
#   mtry = 9
#   trees = 1000
#   min_n = 3
#   tree_depth = 12
#   learn_rate = 0.012945107
#   loss_reduction = 8.71807395454724e-07
#   sample_size = 0.377971
# 
# Engine-Specific Arguments:
#   objective = multi:softprob
# 
# Computational engine: xgboost 
```

# ì›Œí¬í”Œë¡œìš° ì—…ë°ì´íŠ¸ ë° ë§ˆì§€ë§‰ í•™ìŠµ

```{r}
workflow %<>% update_model(final_spec)
xgb_fit <- fit(workflow, data = train2)
```

# ì˜ˆì¸¡í•˜ê¸°

```{r warning=FALSE}
result <- predict(xgb_fit, test2, type = "prob")
result %>% head()
result
```

```{r, message=FALSE}
submission <- read_csv(file.path(file_path, "sample_submission.csv"))
sub_col <- names(submission)
submission <- bind_cols(submission$index, result)
names(submission) <- sub_col
write.csv(submission, row.names = FALSE,
          "baseline_dacon_credit_xgb.csv")
```

