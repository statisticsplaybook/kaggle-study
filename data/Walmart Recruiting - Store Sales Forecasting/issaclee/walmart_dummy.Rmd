---
title: "Walmart baseline with tidymodels"
subtitle: "ë”ë¯¸ ì½”ë”©ì˜ ìœ„ë ¥ğŸ˜²"
author: "Issac Lee"
date: "2/28/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

![Photo steal from [here](https://connectedremag.com/das-in-building-wireless/walmart-verizon-explore-testing-5g-in-some-stores/)](https://connectedremag.com/wp-content/uploads/2020/03/walmart-5G-connected-real-estate.png)

ë³¸ í¬ìŠ¤íŒ…ì€ [ìŠ¬ê¸°ë¡œìš´ í†µê³„ìƒí™œ ìºê¸€ R ìŠ¤í„°ë””](https://www.youtube.com/playlist?list=PLKtLBdGREmMlJCXjCpCi5B4KQ-TsFvAAi) ë°œí‘œìš© í¬ìŠ¤íŒ…ì…ë‹ˆë‹¤.


## ëª©í‘œ

Walmart ë§¤ì¶œ ì˜ˆì¸¡ ëŒ€íšŒì˜ ë² ì´ìŠ¤ë¼ì¸ ëª¨ë¸ì„ `tidymodels`ë¥¼ ì‚¬ìš©í•˜ì—¬ ì¡ì•„ë³¸ë‹¤.

## ì¤€ë¹„ì‘ì—… {.tabset .tabset-fade}

### Library load

ì´ë²ˆ í¬ìŠ¤íŒ…ì—ì„œ ì‚¬ìš©í•  RíŒ¨í‚¤ì§€ë“¤ì„ ë¶ˆëŸ¬ì˜¤ì. íŠ¹íˆ ìš”ì¦˜ í•«í•˜ë”” í•«í•œ `tidymodels` ì‚¬ìš©í•˜ì—¬ ì›”ë§ˆíŠ¸ ëŒ€íšŒë¥¼ ê°€ì§€ê³  ë†€ì•„ë³¸ë‹¤. ë˜í•œ ë§ˆì´ ë¹¼ì´ë³´ë¦¿ ì—°ì‚°ìë“¤ì„ ì‚¬ìš©í•˜ê¸° ìœ„í•˜ì—¬ `magrittr`ë¥¼ ë¶ˆëŸ¬ì™”ë‹¤.ğŸ¤£

```{r load_lib, message=FALSE, warning=FALSE, results='hide'}
library(tidymodels)
library(tidyverse)
library(magrittr)
library(skimr)
library(knitr)
theme_set(theme_bw())
```

### Dataset load

ì´ ëŒ€íšŒì—ì„œ ì£¼ì–´ì§„ ë°ì´í„°ì…‹ì„ ë¶ˆëŸ¬ë³´ì. ì£¼ì–´ì§„ íŒŒì¼ ë¦¬ìŠ¤íŠ¸ëŠ” ë‹¤ìŒê³¼ ê°™ë‹¤.

```{r}
file_path <- "../input/walmart-recruiting-store-sales-forecasting/"
files <- list.files(file_path)
files
```
ê° ë³€ìˆ˜ì˜ ì´ë¦„ì„ `janitor` íŒ¨í‚¤ì§€ë¡œ ë§ë”í•˜ê²Œ ë°”ê¿”ì¤€ë‹¤.

```{r, message=FALSE}
train <- read_csv(file.path(file_path, "train.csv.zip")) %>% 
  janitor::clean_names()
test <- read_csv(file.path(file_path, "test.csv.zip")) %>% 
  janitor::clean_names()
features <- read_csv(file.path(file_path, "features.csv.zip")) %>% 
  janitor::clean_names()
stores <- read_csv(file.path(file_path, "stores.csv")) %>% 
  janitor::clean_names()
```

## ê° ë°ì´í„° ì…‹ ì •ë³´í™•ì¸

ê° `train`ê³¼ `test` ì…‹ì˜ í¬ê¸°ì™€ ë³€ìˆ˜ ì´ë¦„ì„ í™•ì¸í•˜ì. `test` ì…‹ì—ëŠ” ìš°ë¦¬ê°€ ì˜ˆì¸¡í•˜ê³ ì í•˜ëŠ” ë³€ìˆ˜ì¸ `Weekly_Sales`ê°€ í¬í•¨ë˜ì–´ ìˆì§€ ì•ŠìŒì„ ì•Œ ìˆ˜ ìˆë‹¤.

```{r}
# size of data
dim(train)
dim(test)

# train
names(train)
train %>% head()

# test
names(test)
test %>% head()
```

## ì „ì²˜ë¦¬ë¥¼ ìœ„í•œ alldata ìƒì„±

ì „ì²˜ë¦¬ ê³¼ì •ì„ ê±°ì¹  ë•Œ `train`ê³¼ `test`ì…‹ì„ í•©ì³ë†“ìœ¼ë©´ í¸í•œì ì´ ë§ìœ¼ë¯€ë¡œ, `all_data`ë¡œ í•©ì³ë†“ê¸°ë¡œ í•˜ì.

```{r}
# alldata combine
all_data <- bind_rows(train, test)
names(all_data)

all_data %>% head()
all_data %>% skim()
```

## tidymodels - recipeì„ ì´ìš©í•œ ì „ì²˜ë¦¬

ê°€ì¥ ê°„ë‹¨í•œ ì „ì²˜ë¦¬ë¥¼ í•œë‹¤. ìˆ«ì ë³€ìˆ˜ (numeric)ë“¤ì„ normalize ì‹œí‚¤ëŠ” `step_normalize()`ë¥¼ ì´ìš©í•´ì„œ í‰ê· ê³¼ ë¶„ì‚°ì„ ê³„ì‚°, ìŠ¤ì¼€ì¼ë§ì„ ì‹œí–‰í•¨.

```{r}
walmart_recipe <- 
    recipe(weekly_sales ~ .,
           data = all_data) %>% 
    step_mutate(year = lubridate::year(date),
                month = lubridate::month(date)) %>%
    step_rm(date) %>% 
    step_mutate(year = factor(year),
                month = factor(month),
                store = factor(store),
                dept = factor(dept)) %>% 
    step_dummy(all_nominal()) %>%
    step_normalize(all_numeric(), 
                   -all_outcomes()) %>% 
    prep(training = all_data)
walmart_recipe

all_data2 <- juice(walmart_recipe)

names(all_data2)
head(all_data2)
```

## í…ŒìŠ¤íŠ¸, íŠ¸ë ˆì¸ ì…‹ ë¶„ë¦¬

ì „ì²˜ë¦¬ê°€ ëë‚œ `all_data2`ì—ì„œ `train`ì…‹ê³¼ `test`ì…‹ì„ ë¶„ë¦¬í•¨.

```{r}
# train, test
train_index <- seq_len(nrow(train))
train2 <- all_data2[train_index,]
test2 <- all_data2[-train_index,]

train2 %>% dim()
```

## ëª¨ë¸ ì„¤ì • ë° í•™ìŠµ

ê¸°ë³¸ íŒ¨í‚¤ì§€ì— ìˆëŠ” `lm()`í•¨ìˆ˜ë¥¼ ì‚¬ìš©í•˜ì—¬ ì„ í˜• íšŒê·€ë¥¼ ì‚¬ìš©í•˜ê¸° ìœ„í•˜ì—¬, `set_engine()` í•¨ìˆ˜ì˜ ê°’ì„ "lm"ìœ¼ë¡œ ì„¤ì •í•¨. `fit()`ë¥¼ ì‚¬ìš©í•´ì„œ í•™ìŠµí•œë‹¤.

```{r}
lm_model <- 
    linear_reg() %>% 
    set_engine("lm")

lm_form_fit <- 
    lm_model %>% 
    fit(weekly_sales ~ ., data = train2)

lm_form_fit
```

## ì˜ˆì¸¡ ë° ì œì¶œ

`lm_form_fit`ì— ë“¤ì–´ìˆëŠ” ì •ë³´ë¥¼ ì‚¬ìš©í•˜ì—¬ testì…‹ì— ëŒ€ì‘í•˜ëŠ” `weekly_sales`ë¥¼ ì˜ˆì¸¡í•œë‹¤. ì˜ˆì¸¡í•œ ê²°ê³¼ë¥¼ ëŒ€íšŒì—ì„œ ì œê³µí•˜ëŠ” submission íŒŒì¼ì— ë„£ì–´ì„œ ëŒ€íšŒ í™ˆí˜ì´ì§€ì— ì œì¶œí•˜ë©´ ë!

```{r}
result <- predict(lm_form_fit, 
                  new_data = test2)

submission <- read_csv(file.path(file_path, "sampleSubmission.csv.zip"))
submission$Weekly_Sales <- result$.pred
write.csv(submission, row.names = FALSE,
          "baseline-lm-dummy-04022021.csv")
```
